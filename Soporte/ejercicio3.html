<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ciencias Naturales 5° — App Offline</title>
  <meta name="description" content="App didáctica y pedagógica para repasar Ciencias Naturales de 5° primaria. Funciona 100% offline. Incluye evaluación formativa, andamiaje y reporte imprimible."/>
  <link rel="manifest" id="dyn-manifest"/>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent-2:#60a5fa; --warn:#f59e0b; --err:#ef4444; --ok:#10b981; --card:#0b1220; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
    }
    html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial; color:var(--text);
      background: radial-gradient(1200px 700px at 10% -10%, #172554, transparent), radial-gradient(900px 600px at 110% 10%, #14532d, transparent), var(--bg);} 
    header{position:sticky; top:0; z-index:50; backdrop-filter: blur(8px); background: rgba(15,23,42,.6); border-bottom:1px solid rgba(255,255,255,.05);} 
    .wrap{max-width:1100px; margin:0 auto; padding:18px}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:42px;height:42px;border-radius:12px; background: linear-gradient(135deg,var(--accent),var(--accent-2)); box-shadow:var(--shadow); display:grid; place-items:center; font-weight:800; color:#0b1220}
    h1{font-size:clamp(20px,2.5vw,28px); margin:0}
    nav{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    nav button{background:#111827; color:var(--text); border:1px solid rgba(255,255,255,.08); padding:10px 14px; border-radius:12px; cursor:pointer; transition:.2s}
    nav button.active, nav button:hover{ background:#1f2937; transform: translateY(-1px)}
    main{max-width:1100px; margin:18px auto; padding:0 18px 60px}
    .grid{display:grid; gap:18px}
    @media(min-width:880px){.grid{grid-template-columns:1.3fr .7fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px}
    .card h2{margin-top:0; font-size:clamp(18px,2.2vw,24px)}
    .muted{color:var(--muted)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    input[type="number"], input[type="text"], select, textarea{background:#0b1220; color:var(--text); border:1px solid rgba(255,255,255,.1); padding:10px 12px; border-radius:12px; outline:none; width:100%; box-sizing:border-box}
    .btn{ background:var(--accent); color:#06260f; border:none; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700 }
    .btn.sec{ background:#1f2937; color:var(--text); border:1px solid rgba(255,255,255,.12)}
    .btn.warn{ background:var(--warn); color:#241a00 }
    .btn.ghost{ background:transparent; border:1px dashed rgba(255,255,255,.3); color:var(--text)}
    .question{ font-size: clamp(18px, 2.4vw, 24px); font-weight:700; margin:6px 0 12px }
    .result{ padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.12)}
    .result.ok{ background: rgba(16,185,129,.12); border-color: rgba(16,185,129,.5)}
    .result.err{ background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.5)}
    details{ background:#0b1220; border:1px solid rgba(255,255,255,.1); border-radius:12px; padding:10px 12px}
    summary{ cursor:pointer; font-weight:700 }
    .kpi{ display:grid; grid-template-columns: repeat(4,1fr); gap:10px }
    .kpi .cell{ background:#0b1220; border:1px solid rgba(255,255,255,.1); padding:12px; border-radius:12px; text-align:center }
    .kpi .cell b{ font-size:22px; display:block }
    .stars{ color: gold; text-shadow:0 0 8px rgba(255,215,0,.4)}
    .table{ width:100%; border-collapse: collapse; font-size:14px }
    .table th,.table td{ border:1px solid rgba(255,255,255,.12); padding:8px 10px }
    .table th{ background:#111827 }
    .toast{ position:fixed; right:16px; bottom:16px; background:#111827; border:1px solid rgba(255,255,255,.15); padding:10px 12px; border-radius:12px; box-shadow:var(--shadow); display:none }
    canvas.sketch{ background:#0b1220; border:1px solid rgba(255,255,255,.12); border-radius:12px }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo" aria-hidden="true">⚗️</div>
        <div>
          <h1>Ciencias Naturales 5° — App Offline</h1>
          <div class="muted">Práctica guiada y evaluación formativa.</div>
        </div>
      </div>
      <nav aria-label="Módulos">
        <button data-view="inicio" class="active">Inicio</button>
        <button data-view="cuerpo">Cuerpo humano</button>
        <button data-view="ecosistemas">Ecosistemas</button>
        <button data-view="materia">Materia & energía</button>
        <button data-view="fuerzas">Fuerzas & movimiento</button>
        <button data-view="metodo">Método científico</button>
        <button data-view="evaluacion">Evaluación integral</button>
        <button data-view="reporte">Reporte / Memoria</button>
      </nav>
    </div>
  </header>

  <main>
    <section id="inicio" class="grid view card">
      <div class="card">
        <h2>¿Cómo funciona?</h2>
        <p>La app genera actividades <b>aleatorias</b> alineadas a 5°. Incluye <b>pistas</b>, <b>pasos guiados</b> y <b>retroalimentación inmediata</b>. Se adapta según tu desempeño y guarda el progreso en tu dispositivo para trabajar <b>100% offline</b>.</p>
        <div class="row">
          <button class="btn" id="btn-demo">Práctica rápida</button>
          <button class="btn sec" id="btn-clear">Reiniciar progreso</button>
          <span class="muted">Consejo: usa la vista «Reporte / Memoria» para imprimir evidencia.</span>
        </div>
        <h3>Progreso general</h3>
        <div class="kpi" id="kpi"></div>
      </div>
      <aside class="card">
        <h2>Competencias</h2>
        <ul>
          <li>Reconoce órganos y funciones en <b>sistemas del cuerpo</b>.</li>
          <li>Comprende <b>relaciones en ecosistemas</b> (cadena y red trófica, nicho, impacto humano).</li>
          <li>Distingue <b>estados de la materia</b>, <b>cambios físicos</b> vs <b>químicos</b>, y <b>formas de energía</b>.</li>
          <li>Aplica nociones básicas de <b>fuerza</b>, <b>movimiento</b> y <b>máquinas simples</b>.</li>
          <li>Usa el <b>método científico</b>: pregunta, hipótesis, prueba, datos y conclusión.</li>
        </ul>
        <details>
          <summary>Accesibilidad</summary>
          <p>Navegación por teclado, contrastes, sin conexión ni datos personales.</p>
        </details>
      </aside>
    </section>

    <!-- CUERPO HUMANO -->
    <section id="cuerpo" class="view card" hidden>
      <h2>Cuerpo humano</h2>
      <div class="row">
        <label>Subtema:
          <select id="cu-sub">
            <option value="sistemas">Sistemas y funciones</option>
            <option value="nutricion">Hábitos saludables</option>
            <option value="organos">Órganos y ubicación</option>
          </select>
        </label>
        <button class="btn" id="cu-nuevo">Nuevo ejercicio</button>
      </div>
      <div class="question" id="cu-pregunta">Pulsa «Nuevo ejercicio»</div>
      <div id="cu-opciones" class="row"></div>
      <div class="row">
        <button class="btn" id="cu-verificar">Verificar</button>
        <button class="btn sec" id="cu-pista">Pista</button>
      </div>
      <div id="cu-feedback" class="result" hidden></div>
      <details id="cu-pasos" hidden>
        <summary>Pasos sugeridos</summary>
        <ol id="cu-lista-pasos"></ol>
      </details>
      <canvas id="cu-esquema" width="720" height="260" class="sketch" aria-label="Esquema simple del cuerpo" role="img" style="margin-top:10px"></canvas>
    </section>

    <!-- ECOSISTEMAS -->
    <section id="ecosistemas" class="view card" hidden>
      <h2>Ecosistemas</h2>
      <div class="row">
        <label>Actividad:
          <select id="ec-act">
            <option value="cadena">Construir cadena trófica</option>
            <option value="clasificar">Clasificar: productor/consumidor/descomponedor</option>
            <option value="impacto">Impacto humano: causa → efecto</option>
          </select>
        </label>
        <button class="btn" id="ec-nuevo">Nuevo ejercicio</button>
      </div>
      <div class="question" id="ec-pregunta">Pulsa «Nuevo ejercicio»</div>
      <div id="ec-area" class="row"></div>
      <div class="row">
        <button class="btn" id="ec-verificar">Verificar</button>
        <button class="btn sec" id="ec-pista">Pista</button>
      </div>
      <div id="ec-feedback" class="result" hidden></div>
      <details id="ec-pasos" hidden>
        <summary>Pasos sugeridos</summary>
        <ol id="ec-lista-pasos"></ol>
      </details>
    </section>

    <!-- MATERIA & ENERGÍA -->
    <section id="materia" class="view card" hidden>
      <h2>Materia & energía</h2>
      <div class="row">
        <label>Actividad:
          <select id="ma-act">
            <option value="estados">Estados y cambios de la materia</option>
            <option value="fisico-quim">¿Cambio físico o químico?</option>
            <option value="energia">Formas y transformaciones de energía</option>
          </select>
        </label>
        <button class="btn" id="ma-nuevo">Nuevo ejercicio</button>
      </div>
      <div class="question" id="ma-pregunta">Pulsa «Nuevo ejercicio»</div>
      <div id="ma-opciones" class="row"></div>
      <div class="row">
        <button class="btn" id="ma-verificar">Verificar</button>
        <button class="btn sec" id="ma-pista">Pista</button>
      </div>
      <div id="ma-feedback" class="result" hidden></div>
      <details id="ma-pasos" hidden>
        <summary>Pasos sugeridos</summary>
        <ol id="ma-lista-pasos"></ol>
      </details>
    </section>

    <!-- FUERZAS & MOVIMIENTO -->
    <section id="fuerzas" class="view card" hidden>
      <h2>Fuerzas & movimiento</h2>
      <div class="row">
        <label>Actividad:
          <select id="fu-act">
            <option value="fuerza">Identificar fuerzas</option>
            <option value="maquinas">Máquinas simples</option>
            <option value="experimento">Predicción: fuerza, masa y movimiento</option>
          </select>
        </label>
        <button class="btn" id="fu-nuevo">Nuevo ejercicio</button>
      </div>
      <div class="question" id="fu-pregunta">Pulsa «Nuevo ejercicio»</div>
      <div id="fu-area" class="row"></div>
      <div class="row">
        <button class="btn" id="fu-verificar">Verificar</button>
        <button class="btn sec" id="fu-pista">Pista</button>
      </div>
      <div id="fu-feedback" class="result" hidden></div>
      <details id="fu-pasos" hidden>
        <summary>Pasos sugeridos</summary>
        <ol id="fu-lista-pasos"></ol>
      </details>
      <canvas id="fu-sim" width="720" height="220" class="sketch" aria-label="Simulador simple" role="img" style="margin-top:10px"></canvas>
    </section>

    <!-- MÉTODO CIENTÍFICO -->
    <section id="metodo" class="view card" hidden>
      <h2>Método científico</h2>
      <p class="muted">Ordena los pasos y plantea una hipótesis simple.</p>
      <div class="row">
        <button class="btn" id="me-nuevo">Nuevo reto</button>
      </div>
      <div class="question" id="me-pregunta">Pulsa «Nuevo reto»</div>
      <div id="me-area" class="row"></div>
      <textarea id="me-hipo" rows="3" placeholder="Escribe aquí tu hipótesis (se guarda offline)"></textarea>
      <div class="row">
        <button class="btn" id="me-verificar">Verificar</button>
        <button class="btn sec" id="me-pista">Pista</button>
      </div>
      <div id="me-feedback" class="result" hidden></div>
    </section>

    <!-- EVALUACIÓN INTEGRAL -->
    <section id="evaluacion" class="view card" hidden>
      <h2>Evaluación integral (mixta)</h2>
      <p class="muted">Diez ítems aleatorios de todos los módulos.</p>
      <div class="row">
        <button class="btn" id="ev-generar">Generar evaluación</button>
        <button class="btn sec" id="ev-borrar">Borrar evaluación</button>
      </div>
      <div id="ev-lista"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="ev-calificar">Calificar</button>
      </div>
      <div id="ev-feedback" class="result" hidden></div>
    </section>

    <!-- REPORTE / MEMORIA -->
    <section id="reporte" class="view card" hidden>
      <h2>Reporte / Memoria para evidencia</h2>
      <div class="row">
        <button class="btn" id="btn-print">Imprimir / PDF</button>
        <button class="btn sec" id="btn-export">Exportar progreso (.json)</button>
        <input type="file" id="file-import" accept="application/json" style="display:none"/>
        <button class="btn ghost" id="btn-import">Importar progreso</button>
      </div>
      <h3>Resumen</h3>
      <table class="table" id="tabla-reporte">
        <thead><tr><th>Módulo</th><th>Intentos</th><th>Aciertos</th><th>Precisión</th><th>Nivel (1–5)</th><th>Última fecha</th></tr></thead>
        <tbody></tbody>
      </table>
      <h3>Rúbrica sugerida</h3>
      <table class="table">
        <thead><tr><th>Criterio</th><th>Descripción</th><th>Evidencia en app</th></tr></thead>
        <tbody>
          <tr><td>Comprensión científica</td><td>Identifica conceptos y relaciones clave del grado</td><td>Precisión ≥70%, nivel ≥3</td></tr>
          <tr><td>Razonamiento y explicación</td><td>Justifica con pistas/pasos y vocabulario científico básico</td><td>Uso de pasos; reducción de pistas</td></tr>
          <tr><td>Pensamiento investigativo</td><td>Formula hipótesis y conecta datos → conclusiones</td><td>Reto de método científico</td></tr>
          <tr><td>Autonomía</td><td>Gestiona ritmo y dificultad</td><td>Aumento de nivel adaptativo</td></tr>
        </tbody>
      </table>
      <h3>Memoria pedagógica</h3>
      <p>La app implementa andamiaje (Vigotsky), UDL, evaluación formativa y generación aleatoria para promover transferencia. Las actividades contextualizadas favorecen aprendizaje significativo. El registro offline permite auditoría y evidencia.</p>
    </section>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>
  </main>

  <script>
  // Utilidades básicas
  const $ = s=>document.querySelector(s), $$ = s=>Array.from(document.querySelectorAll(s));
  const state = { vista:'inicio', progreso: JSON.parse(localStorage.getItem('cn5_progreso')||'{}'), current:{} };
  const save = ()=> localStorage.setItem('cn5_progreso', JSON.stringify(state.progreso));
  const nowISO = ()=> new Date().toISOString().slice(0,19).replace('T',' ');
  const toast = (m)=>{ const t=$('#toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none',2000)}
  function initModulo(mod){ if(!state.progreso[mod]) state.progreso[mod]={intentos:0, aciertos:0, nivel:1, updated:null}; }
  function pushReporte(mod, ok){ initModulo(mod); const d=state.progreso[mod]; d.intentos++; if(ok) d.aciertos++; d.updated=nowISO();
    state.current.streak = state.current.streak || {ok:0, err:0};
    if(ok){ state.current.streak.ok++; state.current.streak.err=0; if(state.current.streak.ok%3===0) d.nivel=Math.min(5,d.nivel+1) }
    else { state.current.streak.err++; state.current.streak.ok=0; if(state.current.streak.err%2===0) d.nivel=Math.max(1,d.nivel-1) }
    save(); updateKPI(); buildTablaReporte();
  }
  function updateKPI(){ const mods=['cuerpo','ecosistemas','materia','fuerzas','metodo','evaluacion']; const k=$('#kpi'); k.innerHTML='';
    mods.forEach(m=>{ initModulo(m); const d=state.progreso[m]; const prec=d.intentos? Math.round(d.aciertos/d.intentos*100):0; const stars='★'.repeat(Math.min(5,Math.max(1,d.nivel)))+'☆'.repeat(5-Math.min(5,Math.max(1,d.nivel)));
      const cell=document.createElement('div'); cell.className='cell'; cell.innerHTML=`<div class="muted">${m}</div><b>${prec}%</b><div class="stars">${stars}</div>`; k.appendChild(cell); });
  }
  function buildTablaReporte(){ const tb=$('#tabla-reporte tbody'); if(!tb) return; tb.innerHTML=''; Object.entries(state.progreso).forEach(([m,d])=>{
    const prec=d.intentos? Math.round(d.aciertos/d.intentos*100):0; const tr=document.createElement('tr'); tr.innerHTML=`<td>${m}</td><td>${d.intentos}</td><td>${d.aciertos}</td><td>${prec}%</td><td>${d.nivel}</td><td>${d.updated||''}</td>`; tb.appendChild(tr);
  }); }
  function setView(v){ state.vista=v; $$('.view').forEach(s=>s.hidden=(s.id!==v)); $$('nav button').forEach(b=>b.classList.toggle('active', b.dataset.view===v)); if(v==='reporte') buildTablaReporte(); }
  $$('nav button').forEach(b=> b.addEventListener('click', ()=> setView(b.dataset.view)) );

  //=== CUERPO HUMANO ===
  const bancos = {
    sistemas:[
      {q:'¿Qué sistema transporta oxígeno y nutrientes por el cuerpo?', ops:['Digestivo','Circulatorio','Respiratorio','Nervioso'], a:1, pasos:['Recuerda: la sangre lleva oxígeno y nutrientes.','¿Qué sistema mueve la sangre?']},
      {q:'¿Cuál es la función principal del sistema respiratorio?', ops:['Digerir alimentos','Intercambiar gases','Enviar señales eléctricas','Mover músculos'], a:1, pasos:['Piensa en pulmones.','¿Qué entra y sale al respirar?']},
      {q:'¿Qué órgano bombea la sangre?', ops:['Pulmón','Estómago','Corazón','Hígado'], a:2, pasos:['El “motor” del sistema circulatorio.']}
    ],
    habitos:[
      {q:'Para cuidar tus huesos debes consumir…', ops:['Vitamina C','Calcio','Hierro','Sodio'], a:1, pasos:['Leche, queso y yogur son fuentes.']},
      {q:'Dormir bien es importante porque…', ops:['El cuerpo se repara y organiza recuerdos','Se gasta más energía','Se evita crecer','Hace daño al cerebro'], a:0, pasos:['Piensa en descanso y memoria.']}
    ],
    organos:[
      {q:'¿Dónde se produce la digestión química inicial de carbohidratos?', ops:['Boca (saliva)','Estómago','Intestino grueso','Pulmones'], a:0, pasos:['La amilasa salival ayuda.']},
      {q:'¿Qué órgano filtra desechos de la sangre para formar orina?', ops:['Riñones','Pulmones','Hígado','Páncreas'], a:0, pasos:['Piensa en el sistema urinario.']}
    ]
  };
  let cuData=null; function drawEsquemaCuerpo(){ const c=$('#cu-esquema'),x=c.getContext('2d'); x.clearRect(0,0,c.width,c.height); x.strokeStyle='rgba(255,255,255,.6)'; x.lineWidth=2; // silueta simple
    x.beginPath(); x.arc(120,70,30,0,Math.PI*2); x.stroke(); // cabeza
    x.beginPath(); x.moveTo(120,100); x.lineTo(120,200); x.stroke(); // tronco
    x.beginPath(); x.moveTo(120,120); x.lineTo(80,160); x.moveTo(120,120); x.lineTo(160,160); x.stroke(); // brazos
    x.beginPath(); x.moveTo(120,200); x.lineTo(95,240); x.moveTo(120,200); x.lineTo(145,240); x.stroke(); // piernas
    // corazón y pulmones simbólicos
    x.fillStyle='rgba(239,68,68,.8)'; x.beginPath(); x.arc(120,150,8,0,Math.PI*2); x.fill();
    x.fillStyle='rgba(96,165,250,.8)'; x.fillRect(100,130,12,18); x.fillRect(128,130,12,18);
    x.fillStyle='#e5e7eb'; x.fillText('Corazón', 170,150); x.fillText('Pulmones', 170,140);
  }
  function cuNuevo(){ const sub=$('#cu-sub').value; let item; if(sub==='sistemas') item = bancos.sistemas[Math.floor(Math.random()*bancos.sistemas.length)];
    if(sub==='nutricion') item = bancos.habitos[Math.floor(Math.random()*bancos.habitos.length)]; if(sub==='organos') item = bancos.organos[Math.floor(Math.random()*bancos.organos.length)];
    cuData=item; $('#cu-pregunta').textContent=item.q; const cont=$('#cu-opciones'); cont.innerHTML=''; item.ops.forEach((o,i)=>{ const id='cuo'+i; cont.insertAdjacentHTML('beforeend', `<label class="row" style="align-items:flex-start"><input type="radio" name="cuo" value="${i}"> <span>${o}</span></label>`); });
    $('#cu-feedback').hidden=true; $('#cu-pasos').hidden=true; drawEsquemaCuerpo();
  }
  $('#cu-nuevo').addEventListener('click', cuNuevo);
  $('#cu-pista').addEventListener('click', ()=>{ $('#cu-pasos').hidden=false; const ol=$('#cu-lista-pasos'); ol.innerHTML=''; (cuData.pasos||[]).forEach(p=>{ const li=document.createElement('li'); li.textContent=p; ol.appendChild(li); }); });
  $('#cu-verificar').addEventListener('click', ()=>{ const sel=$$('input[name="cuo"]:checked')[0]; const ok = sel && Number(sel.value)===cuData.a; const fb=$('#cu-feedback'); fb.hidden=false; fb.className='result '+(ok?'ok':'err'); fb.textContent = ok? '¡Correcto!': `Respuesta esperada: ${cuData.ops[cuData.a]}`; pushReporte('cuerpo', ok); });

  //=== ECOSISTEMAS ===
  let ecData=null; const especies=['Pasto','Árbol','Conejo','Zorro','Águila','Hongos','Bacterias','Vaca','Lobo','Maíz'];
  function ecNuevo(){ const act=$('#ec-act').value; const area=$('#ec-area'); area.innerHTML=''; $('#ec-feedback').hidden=true; $('#ec-pasos').hidden=true;
    if(act==='cadena'){
      const pool=['Pasto','Conejo','Zorro','Águila','Hongos']; const sel=[...pool].sort(()=>Math.random()-0.5).slice(0,4); const pregunta='Ordena de productor → consumidor → depredador → descomponedor'; $('#ec-pregunta').textContent=pregunta;
      // inputs secuenciales
      sel.forEach((s,i)=> area.insertAdjacentHTML('beforeend', `<div class="row" style="flex:1 1 160px"><span>${i+1}.</span><select class="ec-slot"><option value="">—elige—</option>${pool.map(p=>`<option>${p}</option>`).join('')}</select></div>`));
      ecData={act:'cadena', pool, respuesta:['Pasto','Conejo','Zorro','Hongos'], pasos:['Productor: hace su alimento (fotosíntesis).','Consumidor: come productores u otros animales.','Depredador: caza.','Descomponedor: recicla materia.']}
    }
    if(act==='clasificar'){
      $('#ec-pregunta').textContent='Clasifica cada ser vivo.'; const sel = especies.sort(()=>Math.random()-0.5).slice(0,5);
      sel.forEach(sp=> area.insertAdjacentHTML('beforeend', `<div class="row" style="flex:1 1 220px"><span style="min-width:90px">${sp}</span><select class="ec-cls"><option value="">—rol—</option><option>Productor</option><option>Consumidor</option><option>Descomponedor</option></select></div>`));
      ecData={act:'clasificar', mapa:{'Pasto':'Productor','Árbol':'Productor','Maíz':'Productor','Conejo':'Consumidor','Zorro':'Consumidor','Águila':'Consumidor','Vaca':'Consumidor','Lobo':'Consumidor','Hongos':'Descomponedor','Bacterias':'Descomponedor'}, pasos:['Productor: planta','Consumidor: animal','Descomponedor: desarma restos']}
    }
    if(act==='impacto'){
      $('#ec-pregunta').textContent='Relaciona impacto humano → posible efecto en el ecosistema.';
      const causas=['Deforestación','Contaminación del agua','Caza excesiva','Introducción de especie invasora'];
      const efectos=['Pérdida de hábitat','Muerte de peces','Desequilibrio trófico','Desplaza especies nativas'];
      area.innerHTML = '<table class="table"><thead><tr><th>Causa</th><th>Posible efecto</th></tr></thead><tbody>'+causas.map(c=>`<tr><td>${c}</td><td><select class="ec-imp"><option value="">—efecto—</option>${efectos.map(e=>`<option>${e}</option>`).join('')}</select></td></tr>`).join('')+'</tbody></table>';
      ecData={act:'impacto', mapa:{'Deforestación':'Pérdida de hábitat','Contaminación del agua':'Muerte de peces','Caza excesiva':'Desequilibrio trófico','Introducción de especie invasora':'Desplaza especies nativas'}, pasos:['Piensa en la relación directa causa→efecto.']}
    }
  }
  $('#ec-nuevo').addEventListener('click', ecNuevo);
  $('#ec-pista').addEventListener('click', ()=>{ $('#ec-pasos').hidden=false; const ol=$('#ec-lista-pasos'); ol.innerHTML=''; (ecData.pasos||[]).forEach(p=>{ const li=document.createElement('li'); li.textContent=p; ol.appendChild(li); }); });
  $('#ec-verificar').addEventListener('click', ()=>{
    let ok=false; if(ecData.act==='cadena'){ const vals=$$('.ec-slot').map(s=>s.value); ok = vals.join('|')===ecData.respuesta.join('|'); }
    if(ecData.act==='clasificar'){ const rows=$$('.ec-cls').map((s,i)=>{ const name=s.parentElement.querySelector('span').textContent; return ecData.mapa[name]===s.value; }); ok = rows.every(Boolean); }
    if(ecData.act==='impacto'){ const rows=$$('.ec-imp'); const causas=['Deforestación','Contaminación del agua','Caza excesiva','Introducción de especie invasora']; ok = causas.every((c,i)=> ecData.mapa[c]===rows[i].value ); }
    const fb=$('#ec-feedback'); fb.hidden=false; fb.className='result '+(ok?'ok':'err'); fb.textContent= ok? '¡Bien! Relaciones correctas.' : 'Revisa las relaciones clave (pista disponible).';
    pushReporte('ecosistemas', ok);
  });

  //=== MATERIA & ENERGÍA ===
  let maData=null; function maNuevo(){ const act=$('#ma-act').value; const cont=$('#ma-opciones'); cont.innerHTML=''; $('#ma-feedback').hidden=true; $('#ma-pasos').hidden=true;
    if(act==='estados'){
      const casos=[{q:'El agua al hervir pasa de…', ops:['Líquido a sólido','Sólido a líquido','Líquido a gas','Gas a sólido'], a:2, pasos:['Hervir = evaporación.']}, {q:'El hielo derritiéndose es un cambio…', ops:['Físico','Químico'], a:0, pasos:['No se forma una sustancia nueva.']}];
      maData = casos[Math.floor(Math.random()*casos.length)];
    }
    if(act==='fisico-quim'){
      const casos=[{q:'Oxidar un clavo es un cambio…', ops:['Físico','Químico'], a:1, pasos:['Aparece óxido: nueva sustancia.']}, {q:'Romper un vaso es un cambio…', ops:['Físico','Químico'], a:0, pasos:['Solo cambia la forma.']}];
      maData = casos[Math.floor(Math.random()*casos.length)];
    }
    if(act==='energia'){
      const casos=[{q:'Una linterna convierte energía…', ops:['Química → luminosa','Térmica → sonora','Lumínica → eléctrica'], a:0, pasos:['La pila almacena energía química.']}, {q:'Un molino de viento realiza conversión…', ops:['Luminosa → química','Eólica → eléctrica (generador)','Química → térmica'], a:1, pasos:['El viento mueve aspas conectadas a un generador.']}];
      maData = casos[Math.floor(Math.random()*casos.length)];
    }
    $('#ma-pregunta').textContent=maData.q; maData.ops.forEach((o,i)=> cont.insertAdjacentHTML('beforeend', `<label class="row"><input type="radio" name="mao" value="${i}"> <span>${o}</span></label>`));
  }
  $('#ma-nuevo').addEventListener('click', maNuevo);
  $('#ma-pista').addEventListener('click', ()=>{ $('#ma-pasos').hidden=false; const ol=$('#ma-lista-pasos'); ol.innerHTML=''; (maData.pasos||[]).forEach(p=>{ const li=document.createElement('li'); li.textContent=p; ol.appendChild(li); }); });
  $('#ma-verificar').addEventListener('click', ()=>{ const sel=$$('input[name="mao"]:checked')[0]; const ok = sel && Number(sel.value)===maData.a; const fb=$('#ma-feedback'); fb.hidden=false; fb.className='result '+(ok?'ok':'err'); fb.textContent= ok? '¡Excelente!' : `Esperado: ${maData.ops[maData.a]}`; pushReporte('materia', ok); });

  //=== FUERZAS & MOVIMIENTO ===
  let fuData=null; function fuNuevo(){ const act=$('#fu-act').value; const area=$('#fu-area'); area.innerHTML=''; $('#fu-feedback').hidden=true; $('#fu-pasos').hidden=true; const rnd=(a,b)=> Math.floor(Math.random()*(b-a+1))+a;
    if(act==='fuerza'){
      const casos=[{q:'Si empujas una caja y no se mueve, entonces…', ops:['No hay fuerza','La fuerza no vence la fricción','La caja pierde masa'], a:1, pasos:['Piensa en fricción y fuerza neta.']}, {q:'Al soltar una pelota desde cierta altura, actúa principalmente…', ops:['Fuerza de gravedad','Fuerza magnética','Fuerza eléctrica'], a:0, pasos:['Cae hacia la Tierra.']}]; fuData = casos[Math.floor(Math.random()*casos.length)];
      $('#fu-pregunta').textContent=fuData.q; fuData.ops.forEach((o,i)=> area.insertAdjacentHTML('beforeend', `<label class="row"><input type="radio" name="fuo" value="${i}"> <span>${o}</span></label>`));
    }
    if(act==='maquinas'){
      $('#fu-pregunta').textContent='Selecciona la máquina simple adecuada para izar una carga con menos fuerza.'; const ops=['Palanca','Polea fija','Plano inclinado']; fuData={a:1, ops, pasos:['La polea cambia la dirección y puede reducir esfuerzo con poleas compuestas.']}; ops.forEach((o,i)=> area.insertAdjacentHTML('beforeend', `<label class="row"><input type="radio" name="fuo" value="${i}"> <span>${o}</span></label>`));
    }
    if(act==='experimento'){
      const m=rnd(1,5), F=rnd(2,15); $('#fu-pregunta').textContent=`Predice: con masa ${m} kg y fuerza ${F} N, la aceleración será mayor, menor o igual que con ${m} kg y ${F-1} N.`; const ops=['Mayor','Menor','Igual']; fuData={a:0, ops, pasos:['A mayor fuerza con misma masa, mayor aceleración (relación directa).']}; ops.forEach((o,i)=> area.insertAdjacentHTML('beforeend', `<label class="row"><input type="radio" name="fuo" value="${i}"> <span>${o}</span></label>`));
      drawSim(F);
    }
  }
  function drawSim(F){ const c=$('#fu-sim'),x=c.getContext('2d'); x.clearRect(0,0,c.width,c.height); // suelo
    x.strokeStyle='rgba(255,255,255,.5)'; x.beginPath(); x.moveTo(40,180); x.lineTo(680,180); x.stroke();
    // bloque
    const acc = F/10; const dx = Math.min(600, acc*20);
    x.fillStyle='rgba(96,165,250,.9)'; x.fillRect(60+dx,140,60,40); x.fillStyle='#e5e7eb'; x.fillText(`F=${F}N`, 60, 130); x.fillText(`a≈${(acc).toFixed(1)} u.`, 60, 200);
    // flecha
    x.beginPath(); x.moveTo(60,160); x.lineTo(60+dx,160); x.lineTo(60+dx-8,155); x.moveTo(60+dx,160); x.lineTo(60+dx-8,165); x.stroke();
  }
  $('#fu-nuevo').addEventListener('click', fuNuevo);
  $('#fu-pista').addEventListener('click', ()=>{ $('#fu-pasos').hidden=false; const ol=$('#fu-lista-pasos'); ol.innerHTML=''; (fuData.pasos||[]).forEach(p=>{ const li=document.createElement('li'); li.textContent=p; ol.appendChild(li); }); });
  $('#fu-verificar').addEventListener('click', ()=>{ const sel=$$('input[name="fuo"]:checked')[0]; const ok = sel && Number(sel.value)===fuData.a; const fb=$('#fu-feedback'); fb.hidden=false; fb.className='result '+(ok?'ok':'err'); fb.textContent= ok? '¡Correcto!' : `Esperado: ${fuData.ops[fuData.a]}`; pushReporte('fuerzas', ok); });

  //=== MÉTODO CIENTÍFICO ===
  let metData=null; function metNuevo(){ $('#me-feedback').hidden=true; const pasos=['Pregunta','Hipótesis','Experimento','Observación de datos','Conclusión']; const desorden=[...pasos].sort(()=>Math.random()-0.5); $('#me-pregunta').textContent='Ordena los pasos del método científico.'; const area=$('#me-area'); area.innerHTML=desorden.map(p=>`<div class="row" style="flex:1 1 180px"><select class="me-slot"><option value="">—paso—</option>${desorden.map(x=>`<option>${x}</option>`).join('')}</select></div>`).join(''); metData={pasos}; }
  $('#me-nuevo').addEventListener('click', metNuevo);
  $('#me-pista').addEventListener('click', ()=> toast('Secuencia típica: Pregunta → Hipótesis → Experimento → Observación → Conclusión') );
  $('#me-verificar').addEventListener('click', ()=>{ const vals=$$('.me-slot').map(s=>s.value); const ok = vals.join('|')===metData.pasos.join('|'); const fb=$('#me-feedback'); fb.hidden=false; fb.className='result '+(ok?'ok':'err'); fb.textContent= ok? '¡Bien! Secuencia correcta.' : 'Ajusta el orden (pista disponible).'; pushReporte('metodo', ok); localStorage.setItem('cn5_hipo', $('#me-hipo').value); });
  $('#me-hipo').value = localStorage.getItem('cn5_hipo')||'';

  //=== EVALUACIÓN INTEGRAL ===
  let evData=[]; function evGenerar(){ evData = []; $('#ev-lista').innerHTML=''; const generadores=[cuNuevo, ecNuevo, maNuevo, fuNuevo]; for(let i=0;i<10;i++){ const pick=generadores[Math.floor(Math.random()*generadores.length)]; pick(); // genera en su módulo
      // tomar copia de ítem actual en formato uniforme {q, ops[], a}
      let item=null; const mod = ['cuerpo','ecosistemas','materia','fuerzas'][generadores.indexOf(pick)];
      if(mod==='cuerpo'){ item={q:cuData.q, ops:cuData.ops, a:cuData.a, mod}; }
      if(mod==='ecosistemas'){ if($('#ec-act').value==='cadena'){ item={q:'Orden correcto de la cadena: Pasto → Conejo → Zorro → Hongos', ops:['Correcto','Incorrecto'], a:0, mod}; } else { // toma primera fila como verificación simple
          item={q:'¿Un hongo es…?', ops:['Productor','Consumidor','Descomponedor'], a:2, mod}; }
      }
      if(mod==='materia'){ item={q:maData.q, ops:maData.ops, a:maData.a, mod}; }
      if(mod==='fuerzas'){ item={q:fuData.q, ops:fuData.ops, a:fuData.a, mod}; }
      evData.push(item);
    }
    // Render
    evData.forEach((it,idx)=>{ const cont=document.createElement('div'); cont.className='card'; cont.style.marginTop='10px'; cont.innerHTML=`<div class="muted">Ítem ${idx+1} — ${it.mod}</div><div class="question">${it.q}</div>` + it.ops.map((o,i)=>`<label class="row"><input type="radio" name="ev${idx}" value="${i}"> <span>${o}</span></label>`).join(''); $('#ev-lista').appendChild(cont); });
    $('#ev-feedback').hidden=true; setView('evaluacion');
  }
  $('#ev-generar').addEventListener('click', evGenerar);
  $('#ev-borrar').addEventListener('click', ()=>{ evData=[]; $('#ev-lista').innerHTML=''; $('#ev-feedback').hidden=true; });
  $('#ev-calificar').addEventListener('click', ()=>{ let ok=0; evData.forEach((it,i)=>{ const sel=$$("input[name='ev"+i+"']:checked")[0]; if(sel && Number(sel.value)===it.a) ok++; }); const fb=$('#ev-feedback'); fb.hidden=false; fb.className='result '+(ok>=7?'ok':'err'); fb.textContent = `Resultado: ${ok}/10 correctas.`; pushReporte('evaluacion', ok>=7); });

  //=== Reporte: imprimir / exportar / importar ===
  $('#btn-print').addEventListener('click', ()=> window.print());
  $('#btn-export').addEventListener('click', ()=>{ const blob=new Blob([JSON.stringify(state.progreso,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='progreso_ciencias5.json'; a.click(); });
  $('#btn-import').addEventListener('click', ()=> $('#file-import').click());
  $('#file-import').addEventListener('change', async e=>{ const f=e.target.files[0]; if(!f) return; try{ const txt=await f.text(); state.progreso=JSON.parse(txt); save(); updateKPI(); buildTablaReporte(); toast('Progreso importado.'); }catch{ alert('Archivo inválido'); } });

  // Inicio y service worker
  $('#btn-demo').addEventListener('click', ()=>{ setView('cuerpo'); cuNuevo(); });
  $('#btn-clear').addEventListener('click', ()=>{ if(confirm('¿Borrar progreso?')){ localStorage.removeItem('cn5_progreso'); localStorage.removeItem('cn5_hipo'); location.reload(); } });
  updateKPI();
  (function setupPWA(){ const manifest={ name:'Ciencias 5° — Offline', short_name:'Ciencias5', start_url:'.', display:'standalone', background_color:'#0f172a', theme_color:'#22c55e', icons:[] };
    const blob=new Blob([JSON.stringify(manifest)],{type:'application/json'}); const url=URL.createObjectURL(blob); document.getElementById('dyn-manifest').setAttribute('href', url);
    const swCode = `self.addEventListener('install', e=>{ e.waitUntil(caches.open('ciencias5-v1').then(c=>c.addAll(['./']))); self.skipWaiting(); });
      self.addEventListener('activate', e=>{ e.waitUntil(self.clients.claim()); });
      self.addEventListener('fetch', e=>{ e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request).then(res=>{ const copy=res.clone(); caches.open('ciencias5-v1').then(c=>c.put(e.request, copy)).catch(()=>{}); return res; }).catch(()=>caches.match('./')) )); });`;
    const swBlob=new Blob([swCode],{type:'text/javascript'}); const swURL=URL.createObjectURL(swBlob); if('serviceWorker' in navigator){ navigator.serviceWorker.register(swURL).catch(()=>{}); }
  })();
  </script>
</body>
</html>
